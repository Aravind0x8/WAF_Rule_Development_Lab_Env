#!/bin/bash

# WAF Lab - System Setup Script
# This script prepares the Ubuntu system for ModSecurity installation

echo "Starting WAF Lab System Setup..."

# Update system packages
echo "Updating system packages..."
sudo apt update && sudo apt upgrade -y

# Install essential packages
echo "Installing essential packages..."
sudo apt install -y \
    curl \
    wget \
    git \
    build-essential \
    libtool \
    autoconf \
    automake

# Install Apache and PHP
echo "Installing Apache and PHP..."
sudo apt install -y \
    apache2 \
    php \
    libapache2-mod-php \
    php-mysql \
    php-curl

# Install MySQL Server
echo "Installing MySQL Server..."
sudo apt install -y mysql-server

# Enable Apache modules
echo "Enabling Apache modules..."
sudo a2enmod rewrite
sudo a2enmod headers
sudo a2enmod ssl

# Create project directory structure
echo "Creating project directory structure..."
sudo mkdir -p /var/www/html/sql-test-app
sudo mkdir -p /etc/modsecurity/rules
sudo mkdir -p /var/log/modsecurity

# Set permissions
echo "Setting permissions..."
sudo chown -R www-data:www-data /var/www/html/sql-test-app
sudo chmod -R 755 /var/www/html/sql-test-app

# Create backup of original Apache config
echo "Backing up Apache configuration..."
sudo cp /etc/apache2/apache2.conf /etc/apache2/apache2.conf.backup

echo "System setup completed successfully!"
echo "Please proceed with ModSecurity installation."